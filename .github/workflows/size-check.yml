name: Size Check

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  size-comparison:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout PR code
      uses: actions/checkout@v4
      
    - name: Cache PlatformIO
      uses: actions/cache@v4
      with:
        path: |
          ~/.platformio
          .pio
        key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
        
    - name: Build PR firmware
      run: |
        pio run --silent 2>&1 | tee pr_build.txt
        
    - name: Extract PR sizes
      id: pr_size
      run: |
        RAM_USED=$(grep -oP "RAM:.*?\K\d+(?= bytes)" pr_build.txt || echo "0")
        FLASH_USED=$(grep -oP "Flash:.*?\K\d+(?= bytes)" pr_build.txt || echo "0")
        echo "ram=$RAM_USED" >> $GITHUB_OUTPUT
        echo "flash=$FLASH_USED" >> $GITHUB_OUTPUT
        
    - name: Checkout base branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.base_ref }}
        clean: true
        
    - name: Build base firmware
      run: |
        pio run --silent 2>&1 | tee base_build.txt
        
    - name: Extract base sizes
      id: base_size
      run: |
        RAM_USED=$(grep -oP "RAM:.*?\K\d+(?= bytes)" base_build.txt || echo "0")
        FLASH_USED=$(grep -oP "Flash:.*?\K\d+(?= bytes)" base_build.txt || echo "0")
        echo "ram=$RAM_USED" >> $GITHUB_OUTPUT
        echo "flash=$FLASH_USED" >> $GITHUB_OUTPUT
        
    - name: Calculate differences
      id: diff
      run: |
        PR_RAM=${{ steps.pr_size.outputs.ram }}
        BASE_RAM=${{ steps.base_size.outputs.ram }}
        PR_FLASH=${{ steps.pr_size.outputs.flash }}
        BASE_FLASH=${{ steps.base_size.outputs.flash }}
        
        RAM_DIFF=$((PR_RAM - BASE_RAM))
        FLASH_DIFF=$((PR_FLASH - BASE_FLASH))
        
        # Calculate percentage change
        if [ $BASE_RAM -ne 0 ]; then
          RAM_PERCENT=$(echo "scale=2; ($RAM_DIFF * 100) / $BASE_RAM" | bc)
        else
          RAM_PERCENT=0
        fi
        
        if [ $BASE_FLASH -ne 0 ]; then
          FLASH_PERCENT=$(echo "scale=2; ($FLASH_DIFF * 100) / $BASE_FLASH" | bc)
        else
          FLASH_PERCENT=0
        fi
        
        echo "ram_diff=$RAM_DIFF" >> $GITHUB_OUTPUT
        echo "flash_diff=$FLASH_DIFF" >> $GITHUB_OUTPUT
        echo "ram_percent=$RAM_PERCENT" >> $GITHUB_OUTPUT
        echo "flash_percent=$FLASH_PERCENT" >> $GITHUB_OUTPUT
        
        # Format for display
        if [ $RAM_DIFF -gt 0 ]; then
          RAM_ICON="üìà"
          RAM_SIGN="+"
        elif [ $RAM_DIFF -lt 0 ]; then
          RAM_ICON="üìâ"
          RAM_SIGN=""
        else
          RAM_ICON="‚û°Ô∏è"
          RAM_SIGN="¬±"
        fi
        
        if [ $FLASH_DIFF -gt 0 ]; then
          FLASH_ICON="üìà"
          FLASH_SIGN="+"
        elif [ $FLASH_DIFF -lt 0 ]; then
          FLASH_ICON="üìâ"
          FLASH_SIGN=""
        else
          FLASH_ICON="‚û°Ô∏è"
          FLASH_SIGN="¬±"
        fi
        
        echo "ram_icon=$RAM_ICON" >> $GITHUB_OUTPUT
        echo "ram_sign=$RAM_SIGN" >> $GITHUB_OUTPUT
        echo "flash_icon=$FLASH_ICON" >> $GITHUB_OUTPUT
        echo "flash_sign=$FLASH_SIGN" >> $GITHUB_OUTPUT
        
    - name: Comment size comparison
      uses: actions/github-script@v7
      with:
        script: |
          const ramDiff = ${{ steps.diff.outputs.ram_diff }};
          const flashDiff = ${{ steps.diff.outputs.flash_diff }};
          const ramPercent = ${{ steps.diff.outputs.ram_percent }};
          const flashPercent = ${{ steps.diff.outputs.flash_percent }};
          
          const comment = `## üìä Size Comparison Report
          
          Comparing this PR against \`${{ github.base_ref }}\` branch:
          
          | Resource | Base | PR | Change | % Change |
          |----------|------|----|---------|---------:|
          | **RAM** | ${{ steps.base_size.outputs.ram }} bytes | ${{ steps.pr_size.outputs.ram }} bytes | ${{ steps.diff.outputs.ram_icon }} ${{ steps.diff.outputs.ram_sign }}${{ steps.diff.outputs.ram_diff }} bytes | ${ramPercent}% |
          | **Flash** | ${{ steps.base_size.outputs.flash }} bytes | ${{ steps.pr_size.outputs.flash }} bytes | ${{ steps.diff.outputs.flash_icon }} ${{ steps.diff.outputs.flash_sign }}${{ steps.diff.outputs.flash_diff }} bytes | ${flashPercent}% |
          
          ${Math.abs(ramDiff) > 1000 ? '‚ö†Ô∏è **Significant RAM change detected!**\n' : ''}${Math.abs(flashDiff) > 10000 ? '‚ö†Ô∏è **Significant Flash change detected!**\n' : ''}
          ---
          *Generated by PlatformIO Size Check*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
